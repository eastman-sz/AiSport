package com.gaode

import android.util.Log
import com.amap.api.maps.AMap
import com.amap.api.maps.CameraUpdateFactory
import com.amap.api.maps.model.*
import com.application.IApplication
import com.sportdata.GpsInfoDbHelper
import com.util.ILog
import com.zz.sport.ai.R
import java.util.ArrayList

class GdMapDrawHelper {

    private var aMap : AMap ?= null

    //用于画线或点，最多只保留两个位置点
    private val latLngs = ArrayList<LatLng>()
    //起点
    private var startPointOverlayOptions: MarkerOptions? = null
    //终点
    private var endPointOverlayOptions: MarkerOptions? = null
    private var startPointMarker: Marker? = null
    private var endPointMarker: Marker? = null
    //画线的色值
    private var polylineOptions: PolylineOptions? = null
    //收到的Gps点的个数，因为在地图上画点太多，会引起页面卡顿,控制在300个点为宜
    private var gpsPointCount = 0
    //应用是否处于前台显示
    private var onAppForeground = true
    //处于后台时的gps点
    private val bpLatLngs = ArrayList<LatLng>()

    constructor(aMap : AMap){
        this.aMap = aMap

        latLngs.clear()

        init()
    }

    //isNormal 0正常 1，不正常 。只有在起点定位是才会返回不正常的点，所以不正常的点仅用来定位
    fun drawLine(latLng: LatLng, isNormal: Int) {
        if (1 == isNormal) {
            latLngs.clear()
        } else {
            gpsPointCount++

            if (1 == gpsPointCount) {
                //首次收到正常的GPS点时，将之前的异常点清空
                latLngs.clear()
            }
        }

        if (!onAppForeground){
            //当App处于后台时，停止在地图上绘轨迹
            return
        }

        latLngs.add(latLng)
        val size = latLngs.size
        if (1 == size) {
            //画起点
            drawStartPoint(latLng)
            return
        }

        //最多只保留两个位置点
        if (size > 2) {
            latLngs.removeAt(0)
        }
        //两点可画线
        drawTraceLine(latLngs)
        drawEndPoint(latLng)
    }

    //应用是否处于前台显示
    fun setAppForeground(isAppForeground : Boolean){
        this.onAppForeground = isAppForeground
        //重回前台时，重绘轨迹
        if (this.onAppForeground){
            reDrawTrace()
        }
    }

    private fun init(){
        //地图设置
        val uiSettings = aMap?.uiSettings
        uiSettings?.isZoomControlsEnabled = false
//        aMap?.minZoomLevel = 12f
        aMap?.moveCamera(CameraUpdateFactory.zoomBy(10f))

        //起点
        val startDescriptor = BitmapDescriptorFactory.fromResource(R.drawable.map_start_point_icon)
        startPointOverlayOptions = MarkerOptions().icon(startDescriptor).draggable(false)
        //终点
        val endDescriptor = BitmapDescriptorFactory.fromResource(R.drawable.moving_end_point_icon)
        endPointOverlayOptions = MarkerOptions().icon(endDescriptor).draggable(false)
        //画线的色值
        val lineColor = IApplication.context?.resources!!.getColor(R.color.c18)
        polylineOptions = PolylineOptions().width(8f).color(lineColor)
    }

    //画起点
    private fun drawStartPoint(latLng: LatLng?) {
        if (null == latLng) {
            return
        }
        Log.e("sport" , "---------画起点----0--------------")
        try {
            if (null == startPointMarker) {
                startPointMarker = aMap?.addMarker(startPointOverlayOptions?.position(latLng))
            }
            startPointMarker?.position = latLng
            //定位
            reloc(latLng)
        } catch (e: Exception) {
        }
    }

    //画终点
    private fun drawEndPoint(latLng: LatLng) {
        if (null == aMap) {
            return
        }
        try {
            if (null == endPointMarker) {
                endPointMarker = aMap?.addMarker(endPointOverlayOptions?.position(latLng))
            }
            endPointMarker?.position = latLng

            //定位
            reloc(latLng)
        } catch (e: Exception) {
        }

    }

    //画线
    private fun drawTraceLine(latLngs: List<LatLng>) {
        if (null == aMap) {
            return
        }
        try {
//            if (gpsPointCount > SportParam.maxGpsPoints) {
//                //大于上限值时，需要清空地图上的点，不需要密集的画点
//                clearAndRedrawMapGps()
//            }

            polylineOptions?.points = latLngs
            aMap?.addPolyline(polylineOptions)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    //定位到某个点
    private fun reloc(latLng: LatLng) {
        if (null == aMap) {
            return
        }
        try {
            aMap?.moveCamera(CameraUpdateFactory.newLatLng(latLng))
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    //清空后重绘轨迹
    private fun reDrawTrace(){
        if (null == aMap) {
            return
        }
        try {
            ILog.e("--------------清空后重绘轨迹-------------------: ${SportParam.sportId}")

            val allLatLngs = GpsInfoDbHelper.getLatLng(SportParam.sportId)

            ILog.e("--------------清空后重绘轨迹-------------------size: ${allLatLngs.size}")

            if (allLatLngs.isEmpty()){
                return
            }
            aMap?.clear()

            val size = allLatLngs.size

            if (1 == size){
                //画起点
                drawStartPoint(allLatLngs[0])
                return
            }
            //画起点
//            drawStartPoint(allLatLngs[0])
            //画轨迹
//            drawTraceLine(allLatLngs)
            //画终点
//            drawEndPoint(allLatLngs[size - 1])

            startPointMarker = null
            endPointMarker = null

            //重新赋值
            latLngs.clear()
            allLatLngs.forEach {
                drawLine(it , 0)
            }

//            latLngs.add(allLatLngs[size - 1])

        }catch (e : Exception){
            e.printStackTrace()
        }
    }


}